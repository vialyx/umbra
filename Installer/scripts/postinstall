#!/bin/bash

# Post-installation script for Umbra
# Sets up LaunchAgent and initial configuration

CURRENT_USER=$(stat -f "%Su" /dev/console)
USER_HOME=$(eval echo ~$CURRENT_USER)
LAUNCH_AGENTS_DIR="$USER_HOME/Library/LaunchAgents"
PLIST_NAME="com.umbra.app.plist"
PLIST_PATH="$LAUNCH_AGENTS_DIR/$PLIST_NAME"

echo "Setting up Umbra for user: $CURRENT_USER"

# Create LaunchAgents directory if it doesn't exist
mkdir -p "$LAUNCH_AGENTS_DIR"

# Create LaunchAgent plist
cat > "$PLIST_PATH" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.umbra.app</string>
    <key>ProgramArguments</key>
    <array>
        <string>/Applications/Umbra.app/Contents/MacOS/Umbra</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>ProcessType</key>
    <string>Interactive</string>
    <key>LimitLoadToSessionType</key>
    <array>
        <string>Aqua</string>
    </array>
    <key>KeepAlive</key>
    <false/>
</dict>
</plist>
EOF

# Set correct permissions
chown "$CURRENT_USER:staff" "$PLIST_PATH"
chmod 644 "$PLIST_PATH"

# Unload existing LaunchAgent if present (clean up any old/stale entries)
sudo -u "$CURRENT_USER" launchctl unload "$PLIST_PATH" 2>/dev/null || true

# Kill any existing Umbra instances to ensure clean start
killall Umbra 2>/dev/null || true

# Give time for processes to terminate
sleep 1

# Load the LaunchAgent
echo "Loading LaunchAgent..."
sudo -u "$CURRENT_USER" launchctl load "$PLIST_PATH"

# Start the app using launchctl (not open) to avoid duplicate instances
# The LaunchAgent will handle auto-start on login
echo "Starting Umbra..."
sudo -u "$CURRENT_USER" launchctl start com.umbra.app 2>/dev/null || true

# Give the app time to launch
sleep 1

echo "Umbra installation complete!"
echo "The application has been started and will launch automatically on login."

exit 0
