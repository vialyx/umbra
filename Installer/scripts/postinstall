#!/bin/bash

# Post-installation script for Umbra
# Sets up LaunchAgent and initial configuration

CURRENT_USER=$(stat -f "%Su" /dev/console)
USER_HOME=$(eval echo ~$CURRENT_USER)
LAUNCH_AGENTS_DIR="$USER_HOME/Library/LaunchAgents"
PLIST_NAME="com.umbra.app.plist"
PLIST_PATH="$LAUNCH_AGENTS_DIR/$PLIST_NAME"

echo "Setting up Umbra for user: $CURRENT_USER"

# Create LaunchAgents directory if it doesn't exist
mkdir -p "$LAUNCH_AGENTS_DIR"

# Create LaunchAgent plist
cat > "$PLIST_PATH" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.umbra.app</string>
    <key>ProgramArguments</key>
    <array>
        <string>/Applications/Umbra.app/Contents/MacOS/Umbra</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>ProcessType</key>
    <string>Interactive</string>
    <key>LimitLoadToSessionType</key>
    <array>
        <string>Aqua</string>
    </array>
</dict>
</plist>
EOF

# Set correct permissions
chown "$CURRENT_USER:staff" "$PLIST_PATH"
chmod 644 "$PLIST_PATH"

# Unload existing LaunchAgent if present
sudo -u "$CURRENT_USER" launchctl unload "$PLIST_PATH" 2>/dev/null || true

# Load the LaunchAgent
sudo -u "$CURRENT_USER" launchctl load "$PLIST_PATH"

# Give LaunchAgent a moment to initialize
sleep 1

# Launch the app immediately using launchctl kickstart (more reliable than open)
echo "Starting Umbra..."
sudo -u "$CURRENT_USER" launchctl kickstart -k "gui/$(id -u $CURRENT_USER)/com.umbra.app" 2>/dev/null || \
sudo -u "$CURRENT_USER" open -a "/Applications/Umbra.app" &

# Wait a moment to ensure the app starts
sleep 2

echo "Umbra installation complete!"
echo "The application has been started and will launch automatically on login."

exit 0
